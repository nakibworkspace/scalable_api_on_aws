name: Deploy to AWS EC2

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      env:
        DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $DOCKER_IMAGE:$IMAGE_TAG .
        docker tag $DOCKER_IMAGE:$IMAGE_TAG $DOCKER_IMAGE:latest
        docker push $DOCKER_IMAGE:$IMAGE_TAG
        docker push $DOCKER_IMAGE:latest
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Pulumi CLI
      uses: pulumi/actions@v4
    
    - name: Install Pulumi dependencies
      run: |
        cd infra
        pip install -r requirements.txt
    
    - name: Configure Pulumi stack
      run: |
        cd infra
        pulumi login
        pulumi stack select dev || pulumi stack init dev
        pulumi config set docker_image ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app:latest
        pulumi config set database_url ${{ secrets.DATABASE_URL }} --secret
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    
    - name: Deploy infrastructure with Pulumi
      uses: pulumi/actions@v4
      with:
        command: up
        stack-name: dev
        work-dir: infra
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    
    - name: Run database migrations
      run: |
        pip install alembic psycopg2-binary sqlalchemy
        alembic upgrade head
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    
    - name: Deploy to EC2 via SSH
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ec2-user
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app:latest
          docker stop fastapi-app || true
          docker rm fastapi-app || true
          docker run -d --name fastapi-app --restart unless-stopped \
            -p 80:8000 \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app:latest
          echo "Container started successfully!"
          docker ps | grep fastapi-app
        EOF
        rm -f private_key.pem
    
    - name: Get deployment URL
      run: |
        cd infra
        echo "Deployment Complete!"
        echo "Application URL: $(pulumi stack output application_url)"
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
