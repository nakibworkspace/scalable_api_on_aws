name: Deploy to AWS EC2

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:  # Also allow manual trigger

env:
  AWS_REGION: ap-southeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      env:
        DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $DOCKER_IMAGE:$IMAGE_TAG .
        docker tag $DOCKER_IMAGE:$IMAGE_TAG $DOCKER_IMAGE:latest
        docker push $DOCKER_IMAGE:$IMAGE_TAG
        docker push $DOCKER_IMAGE:latest
    
    - name: Deploy to EC2 via SSH
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ubuntu
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app:latest
          docker stop fastapi-app || true
          docker rm fastapi-app || true
          docker run -d --name fastapi-app --restart unless-stopped \
            -p 80:8000 \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app:latest
          echo "Container started successfully!"
          docker ps | grep fastapi-app
        EOF
        rm -f private_key.pem
    
    - name: Verify deployment
      run: |
        echo "Deployment complete!"
        echo "Application URL: http://${{ secrets.EC2_HOST }}"
